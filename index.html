<!DOCTYPE html>
<style>
.day {
  fill: #fff;
  stroke: #ccc;
}

.memberName {
  font-size: .8em;
}

.projectName {
	font-size: 1em;
	font-weight: bold;
}

</style>
<html>
<body>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</body>
</html>

<script>

var width = 2000, 
	height = 136,
	margin = { left: 50, right: 50, top: 20, bottom: 100 },
	cellSize = 15,
	startingMonth = 11;

var color = d3.scale.category10();
var day = d3.time.format("%j");

d3.json("projects.json", function(error, data) {
	var start = d3.min(data, function(d) { 
 		return new Date(d.time[0]); });
	var end = d3.max(data, function(d) { 
 		return new Date(d.time[1]); });
 	var projects = data.map(function(d) { return d.project; });

 	var dayshift = daysSince(start);
 	color.domain(projects);
 	//console.log(color.range());
	//projects.map(function(d) { console.log(color(d)); }); 	
    var projectTree = d3.nest()
 					.key(function(d) { return d.name; })
 					.entries(data);

 	var svg = d3.select("body").selectAll("svg")
 			.data(projectTree)
 	  	.enter().append("svg")
 			.attr("class", "name")
 			.attr("width", width)
 			.attr("height", height)
 	  	.append("g")
 		  	.attr("transform", "translate(" + cellSize * 2+ "," + (cellSize) +")");
    
    svg.append("text")
    	.attr("class", "projectName")
    	.style("text-anchor", "middle")
    	.attr("transform", "translate(" + cellSize + "," + cellSize  + ")")
    	.text(function(d) { return d.key; });

    var memberBars = svg.selectAll(".member")
    		.data(function(d) { return d.values[0].members.map(
    			function(s) { return {
    									key: s,
    									values: { name: d.key, time: d.values[0].time }
    								 };
    			}); })
    	.enter()
    	    .append("g")
    		.attr("transform", function(d, i) { return "translate(" + cellSize * 3 + "," + (i+1) * (3* cellSize) +")";});

    memberBars.append("text")
    	.style("text-anchor", "middle")
    	.attr("class", "memberName")
    	.attr("transform", "translate(" + -cellSize + "," + cellSize  + ")")
    	.text(function(d) { return d.key; });

 	var rect = memberBars.selectAll(".day")
 			.data(function(d) { 
 				return d3.time.days(start, end).map(function(s) {
 				if (s >= new Date(d.values.time[0]) && s <= new Date(d.values.time[1])) return { time: s, values: d.values};
 				else { return { time: s, values: undefined } };
 			}); })
 	  	.enter().append("rect")
 	  		.attr("class", "day")
 	 	 	.attr("width", cellSize)
 	  		.attr("height", cellSize)
 	  		.attr("x", function(d) { return dayshift(d.time) * cellSize; })
 	  		.style("fill", function(d) { if(d.values) return color(d.values.name); });

 	
});



function daysSince(start) {
	return function(x) {
		return (x - start) / (1000 * 3600 * 24);
	}
}

</script>